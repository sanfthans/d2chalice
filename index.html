<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://unpkg.com/stimulus/dist/stimulus.umd.js"></script>
  <script>
    (() => {
      const application = Stimulus.Application.start()

      application.register("chalice", class extends Stimulus.Controller {
        static get targets() {
          return [ "slot", "slotOne", "slotTwo", "slotThree", "results", "clear" ]
        }

        connect() {
          this.grid = [
            ['calus_mini_tool', 'trackless_waste', 'hard_truths', 'bad_reputation'],
            ['twilight_oath', 'beloved', 'fate_cries_foul', 'dreaded_venture'],
            ['bad_omens', 'zenobia_d', 'sleepless', 'fixed_odds'],
            ['trust', 'austringer', 'waking_vigil', 'pribina_d'],
            ['drang_baroque', 'the_last_dance', 'anonymous_autumn', 'smugglers_word'],
            ['proelium_fr3', 'main_ingredient', 'the_epicurean', 'erentil_fr4'],
            ['badlander', 'parcel_of_stardust', 'imperial_decree', 'dust_rock_blues'],
            ['tangled_web_cloak', 'exodus_down_cloak', 'reverie_dawn_cloak', 'opulent_stalker_cloak'],
            ['tangled_web_grips', 'exodus_down_grips', 'reverie_dawn_grasps', 'opulent_stalker_grips'],
            ['tangled_web_strides', 'exodus_down_strides', 'reverie_dawn_strides', 'opulent_stalker_strides'],
            ['tangled_web_mask', 'exodus_down_mask', 'reverie_dawn_casque', 'opulent_stalker_mask'],
            ['tangled_web_vest', 'exodus_down_vest', 'reverie_dawn_hauberk', 'opulent_stalker_vest']
          ]

          this.namesGrid = [
            ['CALUS Mini-Tool', 'Trackless Waste', 'Hard Truths', 'Bad Reputation'],
            ['Twilight Oath', 'Beloved', 'Fate Cries Foul', 'Dreaded Venture'],
            ['Bad Omens', 'Zenobia-D', 'Sleepless', 'Fixed Odds'],
            ['Trust', 'Austringer', 'Waking Vigil', 'Pribina-D'],
            ['Drang (Baroque)', 'The Last Dance', 'Anonymous Autumn', "Smuggler's Word"],
            ['Proelium FR3', 'Main Ingredient', 'The Epicurean', 'Erentil FR4'],
            ['Badlander', 'Parcel of Stardust', 'Imperial Decree', 'Dust Rock Blues'],
            ["Class (Tangled Shore)", "Class (Menagerie)", "Class (Dreaming City)", "Class (Menagerie)"],
            ["Gloves (Tangled Shore)", "Gloves (Menagerie)", "Gloves (Dreaming City)", "Gloves (Menagerie)"],
            ["Boots (Tangled Shore)", "Boots (Menagerie)", "Boots (Dreaming City)", "Boots (Menagerie)"],
            ["Helmet (Tangled Shore)", "Helmet (Menagerie)", "Helmet (Dreaming City)", "Helmet (Menagerie)"],
            ["Chest (Tangled Shore)", "Chest (Menagerie)", "Chest (Dreaming City)", "Chest (Menagerie)"]
          ]

          this.selectedCol = null
          this.selectedRow = null
          this.selectedResistance = null
          this.selectedMasterwork = null
          this.clearable = false
        }

        togglePicker(e) {
          let slot = e.target.closest(".slot")

          if ((slot === this.slotTwoTarget && this.selectedCol === null) || (slot === this.slotThreeTarget && this.selectedRow === null)) {
            return
          }

          slot.classList.toggle("is-open")

          // close other pickers
          this.slotTargets.forEach(el => {
            if (el !== slot) {
              el.classList.remove("is-open")
            }
          })
        }

        makeSelection(e) {
          // update slot image
          let slot = e.target.closest(".slot")
          let selected = e.target.src
          slot.querySelector("img").src = selected

          // update text
          slot.querySelector(".slot-name").innerHTML = e.target.dataset["name"]

          // close picker
          slot.classList.remove("is-open")

          if (slot === this.slotOneTarget) {
            this.selectedCol = parseInt(e.target.dataset["column"])
          } else if (slot === this.slotTwoTarget) {
            this.selectedRow = parseInt(e.target.dataset["row"])
          } else if (slot === this.slotThreeTarget) {
            this.selectedResistance = e.target.dataset["resistance"]
            this.selectedMasterwork = e.target.dataset["masterwork"]
          }

          this.clearable = true
          this.clearTarget.classList.remove("hidden")
          this.showResults()
        }

        showResults() {
          let controller = this
          let selected = ""
          let name = ""
          let resultsTarget = this.resultsTarget

          if (this.selectedCol !== null) {
            // both slots being used
            if (this.selectedRow !== null) {
              selected = this.grid[this.selectedCol][this.selectedRow]
              name = this.namesGrid[this.selectedCol][this.selectedRow]

              // all three slots being used
              if (this.selectedResistance !== null) {
                let capitalized = this.selectedResistance.charAt(0).toUpperCase() + this.selectedResistance.slice(1)
                // armor selected. show resistance
                if (this.selectedCol > 6) {
                  resultsTarget.innerHTML = `
                  <div class='result'>
                    <img class="main" src="images/${selected}.jpg" >
                    <span class='result-name'>${name}</span>
                    <span class='modifier-text'>${capitalized} Resistance</span>
                    <img class="modifier" src="images/${this.selectedResistance}.png" >
                  </div>`

                // weapon selected. show masterwork
                } else {
                  let capitalized = this.selectedMasterwork.charAt(0).toUpperCase() + this.selectedMasterwork.slice(1)

                  resultsTarget.innerHTML = `
                  <div class='result'>
                    <img class="main" src="images/${selected}.jpg" >
                    <span class='result-name'>${name}</span>
                    <span class='modifier-text'>${capitalized} Masterwork</span>
                    <img class="modifier" src="images/${this.selectedMasterwork}.jpg" >
                  </div>`
                }

              } else {
                resultsTarget.innerHTML = `
                <div class='result'>
                  <img class="main" src="images/${selected}.jpg" ><span class='result-name'>${name}</span>
                </div>`
              }
            } else {
              selected = this.grid[this.selectedCol]
              name =
              resultsTarget.innerHTML = ""
              selected.forEach((selected, i) => {
                let name = controller.namesGrid[this.selectedCol][i]
                let node = document.createElement("div")
                node.classList.add("result")
                node.innerHTML = `<img class="main" src="images/${selected}.jpg" ><span class='result-name'>${name}</span>`
                resultsTarget.appendChild(node)
              })
            }
          }
        }

        clearSelection(e) {
          if (!this.clearable) {
            return
          }
          let controller = this

          // reset all slots
          this.slotTargets.forEach(slot => {
            slot.querySelector("img").src = "images/slot.png"
            slot.querySelector(".slot-name").innerHTML = slot.dataset["name"]
            slot.classList.remove("is-open")
          })

          // reset selected values
          this.selectedCol = null
          this.selectedRow = null
          this.selectedResistance = null
          this.selectedMasterwork = null
          this.clearable = false

          // clear results
          this.resultsTarget.innerHTML = ""

          // hide clear button
          this.clearTarget.classList.add("hidden")
        }

      })
    })()
  </script>
  <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
  <style media="screen">
    body {
      font-family: 'Roboto', sans-serif;
      font-weight: bold;
    }
    .container {
      max-width: 800px;
      margin: 100px auto 0;
    }
    .slot {
      display: flex;
      justify-content: center;
      position:relative;
      cursor: pointer;
    }
    .slot-name {
      position: absolute;
      top: -20px;
      color: white;
    }
    .picker {
      display: none;
      position: absolute;
      top: 100px;
      width: 300px;
      flex-wrap: wrap;
      background-color: #252525;
      z-index: 1;
    }
    [data-target*="chalice.slotTwo"] .picker {
      left: 0;
    }
    [data-target*="chalice.slotThree"] .picker {
      right: 0;
    }

    .picker img {
      width: 50px;
      height: 50px;
      cursor: pointer;
    }
    .slot.is-open .picker {
      display: flex;
    }
    .slot-container {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
      padding-bottom: 30px;
      border-bottom: 2px solid #5a5a5a;
    }
    .chalice {
      display: flex;
      justify-content: center;
    }
    .results, .clear-container {
      display: flex;
      justify-content: center;
      margin-top: 50px;
    }
    .clear-container {
      margin-top: 20px;
    }
    .clear {
      background: none;
      font-size: 1rem;
      color: #e47272;
      border: 1px solid #e47272;
      padding: 10px;
      border-radius: 5px;
    }
    .clear:hover {
      color: #9e4444;
      border-color: #9e4444;
    }
    .clear.hidden {
      display: none;
    }
    .result {
      display: flex;
      flex-direction: column;
      margin-left: 30px;
      position: relative;
    }
    .result img.main {
      min-width: 115px;
    }
    .result:first-child {
      margin-left: 0px;
    }
    .result-name, .modifier-text {
      font-size: .7rem;
      color: white;
      text-align: center;
      margin-top: 10px;
    }
    .modifier-text {
      margin-top: 3px;
    }
    .result img.modifier {
      width: 30px;
      height: 30px;
      position: absolute;
      top: 85px;
      right: 0;
    }
  </style>
<head>
<body style="background-color:#252525;">
  <div class="container" data-controller="chalice">

    <div class="slot" data-target="chalice.slotOne chalice.slot" data-name="Slot 1">
      <img src="images/slot.png" data-action="click->chalice#togglePicker">
      <div class="slot-name">Slot 1</div>
      <div class="picker">
        <img src="images/beast.png" data-action="click->chalice#makeSelection"
          data-name="Beast" data-column="0" title="Beast">
        <img src="images/joy.png" data-action="click->chalice#makeSelection"
          data-name="Joy" data-column="7" title="Joy">
        <img src="images/jubilation.png" data-action="click->chalice#makeSelection"
          data-name="Jubilation" data-column="1" title="Jubilation">
        <img src="images/ambition.png" data-action="click->chalice#makeSelection"
          data-name="Ambition" data-column="2" title="Ambition">
        <img src="images/cunning.png" data-action="click->chalice#makeSelection"
          data-name="Cunning" data-column="8" title="Cunning">
        <img src="images/gluttony.png" data-action="click->chalice#makeSelection"
          data-name="Gluttony" data-column="9" title="Gluttony">
        <img src="images/desire.png" data-action="click->chalice#makeSelection"
          data-name="Desire" data-column="3" title="Desire">
        <img src="images/pride.png" data-action="click->chalice#makeSelection"
          data-name="Pride" data-column="4" title="Pride">
        <img src="images/war.png" data-action="click->chalice#makeSelection"
          data-name="War" data-column="10" title="War">
        <img src="images/excess.png" data-action="click->chalice#makeSelection"
          data-name="Excess" data-column="5" title="Excess">
        <img src="images/pleasure.png" data-action="click->chalice#makeSelection"
          data-name="Pleasure" data-column="11" title="Pleasure">
        <img src="images/wealth.png" data-action="click->chalice#makeSelection"
          data-name="Wealth" data-column="6" title="Wealth">
      </div>
    </div>

    <div class="slot-container">
      <div class="slot" data-target="chalice.slotTwo chalice.slot" data-name="Slot 2">
        <img src="images/slot.png" data-action="click->chalice#togglePicker">
        <div class="slot-name">Slot 2</div>
        <div class="picker">
          <img src="images/beast.png" data-action="click->chalice#makeSelection"
            data-name="Beast" data-row="0" title="Beast">
          <img src="images/joy.png" data-action="click->chalice#makeSelection"
            data-name="Joy" data-row="0" title="Joy">
          <img src="images/jubilation.png" data-action="click->chalice#makeSelection"
            data-name="Jubilation" data-row="0" title="Jubilation">
          <img src="images/ambition.png" data-action="click->chalice#makeSelection"
            data-name="Ambition" data-row="1" title="Ambition">
          <img src="images/cunning.png" data-action="click->chalice#makeSelection"
            data-name="Cunning" data-row="1" title="Cunning">
          <img src="images/gluttony.png" data-action="click->chalice#makeSelection"
            data-name="Gluttony" data-row="1" title="Gluttony">
          <img src="images/desire.png" data-action="click->chalice#makeSelection"
            data-name="Desire" data-row="2" title="Desire">
          <img src="images/pride.png" data-action="click->chalice#makeSelection"
            data-name="Pride" data-row="2" title="Pride">
          <img src="images/war.png" data-action="click->chalice#makeSelection"
            data-name="War"  data-row="2" title="War">
          <img src="images/excess.png" data-action="click->chalice#makeSelection"
            data-name="Excess" data-row="3" title="Excess">
          <img src="images/pleasure.png" data-action="click->chalice#makeSelection"
            data-name="Pleasure"  data-row="3" title="Pleasure">
          <img src="images/wealth.png" data-action="click->chalice#makeSelection"
            data-name="Wealth" data-row="3" title="Wealth">
        </div>
      </div>

      <div class="chalice">
        <img src="images/chalice.jpeg">
      </div>

      <div class="slot" data-target="chalice.slotThree chalice.slot" data-name="Slot 3">
        <img src="images/slot.png" data-action="click->chalice#togglePicker">
        <div class="slot-name">Slot 3</div>
        <div class="picker">
          <img src="images/beast.png" data-action="click->chalice#makeSelection"
            data-name="Beast" data-resistance="arc" data-masterwork="handling" title="Beast">
          <img src="images/joy.png" data-action="click->chalice#makeSelection"
            data-name="Joy" data-resistance="arc" data-masterwork="handling" title="Joy">
          <img src="images/jubilation.png" data-action="click->chalice#makeSelection"
            data-name="Jubilation" data-resistance="arc" data-masterwork="handling" title="Jubilation">
          <img src="images/ambition.png" data-action="click->chalice#makeSelection"
            data-name="Ambition" data-resistance="solar" data-masterwork="reload" title="Ambition">
          <img src="images/cunning.png" data-action="click->chalice#makeSelection"
            data-name="Cunning" data-resistance="solar" data-masterwork="reload" title="Cunning">
          <img src="images/gluttony.png" data-action="click->chalice#makeSelection"
            data-name="Gluttony" data-resistance="solar" data-masterwork="reload" title="Gluttony">
          <img src="images/desire.png" data-action="click->chalice#makeSelection"
            data-name="Desire" data-resistance="void" data-masterwork="range" title="Desire">
          <img src="images/pride.png" data-action="click->chalice#makeSelection"
            data-name="Pride" data-resistance="void" data-masterwork="range" title="Pride">
          <img src="images/war.png" data-action="click->chalice#makeSelection"
            data-name="War"  data-resistance="void" data-masterwork="range" title="War">
          <img src="images/excess.png" data-action="click->chalice#makeSelection"
            data-name="Excess" data-resistance="solar" data-masterwork="stability" title="Excess">
          <img src="images/pleasure.png" data-action="click->chalice#makeSelection"
            data-name="Pleasure"  data-resistance="solar" data-masterwork="stability" title="Pleasure">
          <img src="images/wealth.png" data-action="click->chalice#makeSelection"
            data-name="Wealth" data-resistance="solar" data-masterwork="stability" title="Wealth">
        </div>
      </div>
    </div>

    <div class="results" data-target="chalice.results">
    </div>

    <div class="clear-container">
      <button class="clear hidden" data-action="chalice#clearSelection" data-target="chalice.clear">Clear All</button>
    </div>
  </div>
</body>
</html>
